---
title: "uniquely mapped TE scatter plots"
author: "Chenxin Li"
date: "February 21, 2019"
output:
  html_notebook:
    number_sections: yes
    toc: yes
    toc_float: yes
  html_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r}
library(ggplot2)
library(emmeans)
library(tidyr)
library(dplyr)
library(readr)
library(readxl)
library(vegan)
library(edgeR)
library(RColorBrewer)
library(stringr)
library(svglite)
```

#load data
```{r}
g24 <- read.delim("C:/Users/cxli9/Desktop/Li/PBI/PBI299 (Sundar Lab)/smRNA project/CLVS08/TE_unique_mRNA_and_siRNA_counts_Feb21/Gypsy_24nt_unique_siRNA_counts.txt")

t24 <- read.delim("C:/Users/cxli9/Desktop/Li/PBI/PBI299 (Sundar Lab)/smRNA project/CLVS08/TE_unique_mRNA_and_siRNA_counts_Feb21/TIR_24nt_unique_siRNA_counts.txt")

gm <- read.delim("C:/Users/cxli9/Desktop/Li/PBI/PBI299 (Sundar Lab)/smRNA project/CLVS08/TE_unique_mRNA_and_siRNA_counts_Feb21/Gypsy_mRNA_counts.txt")

tm <- read.delim("C:/Users/cxli9/Desktop/Li/PBI/PBI299 (Sundar Lab)/smRNA project/CLVS08/TE_unique_mRNA_and_siRNA_counts_Feb21/non-CACTA_DNA_mRNA_counts.txt")
```
```{r}
sample_des <- read_excel("C:/Users/cxli9/Desktop/Li/PBI/PBI299 (Sundar Lab)/smRNA project/CLVS08/sample_des.xlsx")
seq_depth <- read_excel("C:/Users/cxli9/Desktop/Li/PBI/PBI299 (Sundar Lab)/smRNA project/CLVS08/TE/siRNA_comp.xlsx")
siRNA_length <- read_excel("C:/Users/cxli9/Desktop/Li/PBI/PBI299 (Sundar Lab)/smRNA project/CLVS08/TE/total_siRNA_length.xlsx")
```
```{r}
sample_des <- seq_depth %>% 
  inner_join(siRNA_length, by = c("sample_ID")) %>% 
  inner_join(sample_des, by = c("sample_ID")) %>% 
  select(lib.size, `24nt`, sample_ID, sample_type, genotype) 

sample_des
```

#arrange siRNA data
```{r}
#arrange siRNA tables-gypsy
g24_l <- g24 %>% 
  mutate(tag = paste(X, X.3, X.4, sep = "-")) %>% 
  mutate(class = "Gypsy") %>% 
  mutate(kb =(X.4 - X.3) / 1000) %>% 
  select(-Protoplast.18_S29_L004_R1_001, -X, -X.1, -X.2, -X.3, -X.4, -X.5, -X.6, -X.7, -X.8) %>% 
  gather("lib", "count", 1:28) %>% 
  mutate(sample_ID = case_when(
    str_detect(lib, "sperm.1") ~ "BS1",
    str_detect(lib, "Sperm2") ~ "BS2",
    str_detect(lib, "Sperm4a") ~ "BS4a",
    str_detect(lib, "sperm4b") ~ "BS4b",
    str_detect(lib, "sperm6a") ~ "BS6a",
    str_detect(lib, "sperm6b") ~ "BS6b",
    str_detect(lib, "sperm.5b") ~ "SP5b",
    str_detect(lib, "sperm.5c") ~ "SP5c",
    str_detect(lib, "VegetativeCell1") ~ "BV1",
    str_detect(lib, "VegetativeCell2") ~ "BV2",
    str_detect(lib, "Bulk.15") ~ "B15",
    str_detect(lib, "Bulk.20") ~ "B20",
    str_detect(lib, "Bulk.25") ~ "B25",
    str_detect(lib, "seedling4") ~ "SD4",
    str_detect(lib, "Protoplast.20") ~ "P20",
    str_detect(lib, "Protoplast.25") ~ "P25",
    str_detect(lib, "egg.9a") ~ "E9a",
    str_detect(lib, "egg.9b") ~ "E9b",
    str_detect(lib, "egg.9c") ~ "E9c",
    str_detect(lib, "eggcell4") ~ "E4",
    str_detect(lib, "eggcell3") ~ "E3",
    str_detect(lib, "eggcell2") ~ "E2",
    str_detect(lib, "ovary.no.egg.1a") ~ "OV1a",
    str_detect(lib, "ovary.no.egg.1b") ~ "OV1b",
    str_detect(lib, "Ovarynoegg2") ~ "OV2",
    str_detect(lib, "SRR57") ~ "root",
    str_detect(lib, "ab_control") ~ "ddm1_con",
    str_detect(lib, "ddm1ab") ~ "ddm1"
  )) %>% 
    inner_join(sample_des, by = "sample_ID") %>% 
  mutate(nor.count = count / lib.size / kb) %>% 
  mutate(nor.count.24 = count / `24nt` / kb) 
  
  g24_l %>% head(10)
```

```{r}

t24_l <- t24 %>% 
  mutate(tag = paste(X, X.3, X.4, sep = "-")) %>% 
  mutate(class = "TIR") %>% 
  mutate(kb = (X.4 - X.3) / 1000) %>% 
  select(-Protoplast.18_S29_L004_R1_001, -X, -X.1, -X.2, -X.3, -X.4, -X.5, -X.6, -X.7, -X.8) %>% 
  gather("lib", "count", 1:28) %>% 
  mutate(sample_ID = case_when(
    str_detect(lib, "sperm.1") ~ "BS1",
    str_detect(lib, "Sperm2") ~ "BS2",
    str_detect(lib, "Sperm4a") ~ "BS4a",
    str_detect(lib, "sperm4b") ~ "BS4b",
    str_detect(lib, "sperm6a") ~ "BS6a",
    str_detect(lib, "sperm6b") ~ "BS6b",
    str_detect(lib, "sperm.5b") ~ "SP5b",
    str_detect(lib, "sperm.5c") ~ "SP5c",
    str_detect(lib, "VegetativeCell1") ~ "BV1",
    str_detect(lib, "VegetativeCell2") ~ "BV2",
    str_detect(lib, "Bulk.15") ~ "B15",
    str_detect(lib, "Bulk.20") ~ "B20",
    str_detect(lib, "Bulk.25") ~ "B25",
    str_detect(lib, "seedling4") ~ "SD4",
    str_detect(lib, "Protoplast.20") ~ "P20",
    str_detect(lib, "Protoplast.25") ~ "P25",
    str_detect(lib, "egg.9a") ~ "E9a",
    str_detect(lib, "egg.9b") ~ "E9b",
    str_detect(lib, "egg.9c") ~ "E9c",
    str_detect(lib, "eggcell4") ~ "E4",
    str_detect(lib, "eggcell3") ~ "E3",
    str_detect(lib, "eggcell2") ~ "E2",
    str_detect(lib, "ovary.no.egg.1a") ~ "OV1a",
    str_detect(lib, "ovary.no.egg.1b") ~ "OV1b",
    str_detect(lib, "Ovarynoegg2") ~ "OV2",
    str_detect(lib, "SRR57") ~ "root",
    str_detect(lib, "ab_control") ~ "ddm1_con",
    str_detect(lib, "ddm1ab") ~ "ddm1"
  )) %>% 
    inner_join(sample_des, by = "sample_ID") %>% 
  mutate(nor.count = count / lib.size / kb) %>% 
  mutate(nor.count.24 = count / `24nt`/ kb)
  
  t24_l %>% head(10)
```
```{r}
#summarise 

g24_s <- g24_l %>% 
  group_by(sample_type, genotype, tag, class) %>% 
  summarise(mean.nor.count = mean(nor.count), mean.nor.count.24 = mean(nor.count.24)) %>% 
  ungroup()

head(g24_s, 10)

t24_s <- t24_l %>% 
  group_by(sample_type, genotype, tag, class) %>% 
  summarise(mean.nor.count = mean(nor.count), mean.nor.count.24 = mean(nor.count.24)) %>% 
  ungroup()
  

head(t24_s, 10)
```
```{r}
siRNA <- rbind(g24_s, t24_s) %>% 
  mutate(RNA_type = "24nt siRNA") 
```


#arrange mRNA data 
```{r}
#arrange mRNA tables. load metadata first
mRNA_sample_des <- read_excel("C:/Users/cxli9/Desktop/Li/PBI/PBI299 (Sundar Lab)/smRNA project/mRNA/zg_sample_des.xlsx")
mRNA_depth_info <- read_excel("C:/Users/cxli9/Desktop/Li/PBI/PBI299 (Sundar Lab)/smRNA project/CLVS08/TE_unique_mRNA_and_siRNA_counts_Feb21/mRNA_depth_info.xlsx")
```

```{r}
mRNA_info <- mRNA_depth_info %>% 
  mutate(sample_ID = case_when(
    str_detect(library, "EC1") ~ "EC1",
    str_detect(library, "EC2") ~ "EC2",
    str_detect(library, "EC3") ~ "EC3",
    str_detect(library, "Sp1") ~ "Sp1",
    str_detect(library, "Sp2") ~ "Sp2",
    str_detect(library, "Sp3") ~ "Sp3",
    str_detect(library, "Ve1") ~ "Ve1",
    str_detect(library, "Ve2") ~ "Ve2",
    str_detect(library, "Ve3") ~ "Ve3",
    str_detect(library, "Z2.5_rep1") ~ "Z2.5_1",
    str_detect(library, "Z2.5_rep2") ~ "Z2.5_2",
    str_detect(library, "Z2.5_rep3") ~ "Z2.5_3",
    str_detect(library, "Z5_rep1") ~ "Z5_1",
    str_detect(library, "Z5_rep2") ~ "Z5_2",
    str_detect(library, "Z5_rep3") ~ "Z5_3",
    str_detect(library, "Z9_rep1") ~ "Z9_1",
    str_detect(library, "Z9_rep2") ~ "Z9_2",
    str_detect(library, "Z9_rep3") ~ "Z9_3",
    str_detect(library, "seedling_rep1") ~ "Seedling1",
    str_detect(library, "seedling_rep2") ~ "Seedling2",
    str_detect(library, "seedling_rep3") ~ "Seedling3"
  )) %>% 
  inner_join(mRNA_sample_des, by = "sample_ID") %>% 
  mutate(rRNA_subtracted_total = Total - NOR)

mRNA_info
```
```{r}
mRNA_info_l <- mRNA_info %>% 
  gather("features", "counts", 2:8) %>% 
  mutate(proportion  = counts/Total) %>% 
  mutate(proportion.rRNA.sub = counts/rRNA_subtracted_total)

mRNA_info_l %>% head(10)  
```


```{r}
gm_l <- gm %>% 
  mutate(tag = paste(X, X.3, X.4, sep = "-")) %>%
  mutate(class = "Gypsy") %>% 
  mutate(kb = (X.4 - X.3) / 1000) %>% 
  select(-X, -X.1, -X.2, -X.3, -X.4, -X.5, -X.6, -X.7, -X.8) %>% 
  gather("library", "count", 1:21) %>% 
  mutate(sample_ID = case_when(
    str_detect(library, "EC1") ~ "EC1",
    str_detect(library, "EC2") ~ "EC2",
    str_detect(library, "EC3") ~ "EC3",
    str_detect(library, "Sp1") ~ "Sp1",
    str_detect(library, "Sp2") ~ "Sp2",
    str_detect(library, "Sp3") ~ "Sp3",
    str_detect(library, "Ve1") ~ "Ve1",
    str_detect(library, "Ve2") ~ "Ve2",
    str_detect(library, "Ve3") ~ "Ve3",
    str_detect(library, "Z2.5_rep1") ~ "Z2.5_1",
    str_detect(library, "Z2.5_rep2") ~ "Z2.5_2",
    str_detect(library, "Z2.5_rep3") ~ "Z2.5_3",
    str_detect(library, "Z5_rep1") ~ "Z5_1",
    str_detect(library, "Z5_rep2") ~ "Z5_2",
    str_detect(library, "Z5_rep3") ~ "Z5_3",
    str_detect(library, "Z9_rep1") ~ "Z9_1",
    str_detect(library, "Z9_rep2") ~ "Z9_2",
    str_detect(library, "Z9_rep3") ~ "Z9_3",
    str_detect(library, "seedling_rep1") ~ "Seedling1",
    str_detect(library, "seedling_rep2") ~ "Seedling2",
    str_detect(library, "seedling_rep3") ~ "Seedling3"
  )) %>% 
  inner_join(mRNA_sample_des, by = "sample_ID") %>% 
  inner_join(mRNA_info %>% 
               select(Total, sample_ID), by = "sample_ID") %>% 
  mutate(nor.count = count/Total/kb)




gm_l %>% head(10)
```
```{r}
tm_l <- tm %>% 
  mutate(tag = paste(X, X.3, X.4, sep = "-")) %>%
  mutate(class = "TIR") %>% 
  mutate(kb = (X.4 - X.3) / 1000) %>% 
  select(-X, -X.1, -X.2, -X.3, -X.4, -X.5, -X.6, -X.7, -X.8) %>% 
  gather("library", "count", 1:21) %>% 
  mutate(sample_ID = case_when(
    str_detect(library, "EC1") ~ "EC1",
    str_detect(library, "EC2") ~ "EC2",
    str_detect(library, "EC3") ~ "EC3",
    str_detect(library, "Sp1") ~ "Sp1",
    str_detect(library, "Sp2") ~ "Sp2",
    str_detect(library, "Sp3") ~ "Sp3",
    str_detect(library, "Ve1") ~ "Ve1",
    str_detect(library, "Ve2") ~ "Ve2",
    str_detect(library, "Ve3") ~ "Ve3",
    str_detect(library, "Z2.5_rep1") ~ "Z2.5_1",
    str_detect(library, "Z2.5_rep2") ~ "Z2.5_2",
    str_detect(library, "Z2.5_rep3") ~ "Z2.5_3",
    str_detect(library, "Z5_rep1") ~ "Z5_1",
    str_detect(library, "Z5_rep2") ~ "Z5_2",
    str_detect(library, "Z5_rep3") ~ "Z5_3",
    str_detect(library, "Z9_rep1") ~ "Z9_1",
    str_detect(library, "Z9_rep2") ~ "Z9_2",
    str_detect(library, "Z9_rep3") ~ "Z9_3",
    str_detect(library, "seedling_rep1") ~ "Seedling1",
    str_detect(library, "seedling_rep2") ~ "Seedling2",
    str_detect(library, "seedling_rep3") ~ "Seedling3"
  )) %>% 
  inner_join(mRNA_sample_des, by = "sample_ID") %>% 
  inner_join(mRNA_info %>% 
               select(Total, sample_ID), by = "sample_ID") %>% 
  mutate(nor.count = count/Total/kb)




tm_l %>% head(10)
```
```{r}
#summarise
gm_s <- gm_l %>% 
  group_by(sample_type, tag, class) %>% 
  summarise(mean.nor.count = mean(nor.count)) %>% 
  ungroup()

head(gm_s, 10)

tm_s <- tm_l %>% 
  group_by(sample_type, tag, class) %>% 
  summarise(mean.nor.count = mean(nor.count)) %>% 
  ungroup()

head(tm_s, 10)
```
#Overview of mRNA mapping to different genomic features

```{r}
palette <- read_excel("C:/Users/cxli9/Desktop/Li/PBI/PBI299 (Sundar Lab)/smRNA project/palette.xlsx")
```
```{r}
pal <- palette[palette$sample_type %in% mRNA_info_l$sample_type, ] %>% 
  arrange(sample_type)
pal
```

```{r}
mRNA_info_l %>% 
  filter(features != "Genes") %>% 
  filter(features != "NOR") %>%
  filter(features == "Gypsy"|
           features == "TIR") %>% 
  ggplot(aes(x = sample_type, y = proportion.tot)) +
  facet_grid(. ~ features, space = "free", scales = "free") +
  #geom_bar(stat = "summary", fun.y = mean, aes(fill = sample_type), alpha = 0.8)+
  geom_point(aes(color = sample_type), size = 2.5, alpha = 0.8) +
  #geom_text(data = grouping, aes(y = upper, label = .group), size = 5, fontface = "bold") +
  scale_color_manual(values = c("tomato1", "orange", "seagreen", "dodgerblue2", "violetred2", "violetred3", "violetred4")) +
  labs(x = NULL,
       color = NULL) +
  scale_x_discrete(labels = c("egg", "pollen VC", "seedling", "sperm", "Z2.5 hrs", "Z5 hrs", "Z9 hrs")) +
  theme_minimal() +
  theme(legend.position = "none") +
  theme(text = element_text(size = 18, face="bold")) +
  theme(axis.text.x = element_text(colour="black", angle = 45, hjust = 1)) +
  theme(axis.text.y = element_text(colour="black")) 

ggsave(filename = "mRNA_TE_proportions.svg", width = 5, height = 6)
  
```



```{r}
mRNA <- rbind(gm_s, tm_s) %>% 
  mutate(RNA_type = "mRNA") %>% 
  mutate(genotype = "WT") 


```



##egg siRNA vs. egg mRNA
```{r}
#siRNA %>% head(10)
egg_mRNA <- mRNA %>% 
 filter(sample_type == "egg") %>% 
               select(-RNA_type, -genotype)

egg_mRNA %>% head(10)
```
```{r}
egg <- siRNA %>% 
  filter(sample_type == "egg") %>% 
  select(-RNA_type, -genotype) %>% 
  full_join(egg_mRNA, by = c("tag", "class", "sample_type")) 

egg %>% arrange(-mean.nor.count.x) %>% head(10)
```



```{r}
# egg %>% 
#   ggplot(aes(x = mean.nor.count.x * 10^6, y = mean.nor.count.y * 10^6)) +
#   facet_grid(.~class, scales = "free") +
#   geom_point(alpha = 0.8, color = "tomato1")+
#   labs(x = "siRNA counts per million per kilobase",
#        y = "mRNA counts per million per kilobase") +
#   theme_minimal() +
#   theme(text = element_text(size = 14, face="bold")) +
#   theme(axis.text.x = element_text(colour="black", angle = 45, hjust = 1)) +
#   theme(axis.text.y = element_text(colour="black"))
# 
# ggsave(filename = "egg siRNA vs. egg mRNA.png", height = 5, width = 5)
```

##sperm siRNA vs. sperm mRNA
```{r}
sperm_mRNA <- mRNA %>% 
 filter(sample_type == "sperm") %>% 
               select(-RNA_type, -genotype)

sperm_mRNA %>% head(10)
```
```{r}
sperm <- siRNA %>% 
  filter(sample_type == "sperm") %>% 
  select(-RNA_type, -genotype) %>% 
  full_join(sperm_mRNA, by = c("tag", "class", "sample_type")) 

sperm %>% arrange(-mean.nor.count.x) %>% head(10)
```



```{r}
# sperm %>% 
#   ggplot(aes(x = mean.nor.count.x * 10^6, y = mean.nor.count.y * 10^6)) +
#   facet_grid(.~class, scales = "free") +
#   geom_point(alpha = 0.8, color = "dodgerblue2")+
#   labs(x = "siRNA counts per million per kilobase",
#        y = "mRNA counts per million per kilobase") +
#   theme_minimal() +
#   theme(text = element_text(size = 14, face="bold")) +
#   theme(axis.text.x = element_text(colour="black", angle = 45, hjust = 1)) +
#   theme(axis.text.y = element_text(colour="black"))
# 
# ggsave(filename = "sperm siRNA vs. sperm mRNA.png", height = 5, width = 5)
```

##seedling siRNA vs. seedling mRNA 
```{r}
#siRNA %>% head(10)
seedling_mRNA <- mRNA %>% 
 filter(sample_type == "seedling shoot") %>% 
               select(-RNA_type, -genotype)

seedling_mRNA %>% head(10)
```
```{r}
seedling <- siRNA %>% 
  filter(sample_type == "seedling shoot") %>% 
  #mutate(sample_type1 = "seedling") %>% 
  #select(-sample_type) %>% 
  #mutate(sample_type = sample_type1) %>% 
  select(-RNA_type, -genotype) %>% 
  full_join(seedling_mRNA, by = c("tag", "class", "sample_type")) 

seedling %>% arrange(-mean.nor.count.x) %>% head(10)
```
 
 


```{r}
fit_df <- rbind(egg, sperm, seedling) %>% 
  mutate(y = log10(mean.nor.count.y  * 10^6 + 1.01)) %>% 
  mutate(x = 1/log10(mean.nor.count.24  * 10^6 + 1.01)) %>% 
  mutate(y_fit = x) %>% 
  mutate(delta = y - y_fit) %>% 
  mutate(side = case_when(
    delta > 0 ~ "out",
    delta < 0 ~ "in"
  )) %>% 
  group_by(sample_type, class, side) %>% 
  summarise(number = n()) %>% 
  ungroup() %>% 
  mutate(x = case_when(
    side == "in" ~ 1,
    side == "out" ~2
  )) %>% 
  mutate(y = case_when(
    side == "in" ~ 0.1,
    side == "out" ~2
  )) 

fit_df
```

```{r}
curve <- data.frame(x = seq(0.29, 3, by= 0.001))
curve <- curve %>% 
  mutate(y = 1/x)

#curve


rbind(egg, sperm, seedling) %>% 
  
  ggplot(aes(x = log10(mean.nor.count.24 * 10^6 + 1) , y = log10(mean.nor.count.y * 10^6 + 1))) + 
  facet_grid(class ~ sample_type, scales = "free") +
  geom_point(alpha = 0.8, aes(color = sample_type)) +
  # stat_bin_2d(bins  = 5, aes(fill = ..density..), alpha = 0.8) +
  labs(x = "log10 siRNA counts per million per kb",
       y = "log10 mRNA counts per million per kb") +
  geom_line(data = curve, aes(x = x, y = y), linetype = 6, size = 1.25) +
  geom_text(data = fit_df, aes(x = x, y = y, label = number), size = 5, fontface = "bold") +
  scale_color_manual(values = c("tomato1", "seagreen", "dodgerblue2"))+
  # scale_fill_gradientn(colours = brewer.pal(9, "YlOrRd")[c(5:9)], na.value = NA) + 
  theme_minimal() +
  theme(legend.position = "none") + 
  theme(text = element_text(size = 18, face="bold")) +
  theme(axis.text.x = element_text(colour="black")) +
  theme(axis.text.y = element_text(colour="black"))

ggsave(filename = "egg_sd_sperm_siRNA_vs_mRNA_log.png", width = 6, height = 6)
# ggsave(filename = "egg_sd_sperm_siRNA_vs_mRNA_log.svg", width = 5, height = 6)
```


##sperm siRNA vs. egg mRNA
```{r}
sp_egg <- siRNA %>% 
  filter(sample_type == "sperm") %>% 
  select(-RNA_type, -genotype, -sample_type) %>% 
  full_join(egg_mRNA, by = c("tag", "class"))

sp_egg %>% tail(10)
```
```{r}
# curve <- data.frame(x = seq(0.29, 3, by= 0.001))
# curve <- curve %>% 
#   mutate(y = 1/x)
# 
# sp_egg %>% 
#   mutate(col = case_when(
#     mean.nor.count.x * 10^6 > 50 ~ "sperm cell",
#     mean.nor.count.y * 10^6 > 100 ~ "egg cell",
#     mean.nor.count.x * 10^6 < 50 &
#       mean.nor.count.y * 10^6 < 100 ~ "neither"
#   )) %>% 
#   ggplot(aes(x = log10(mean.nor.count.x * 10^6 + 1), y = log10(mean.nor.count.y * 10^6 + 1))) +
#   facet_grid(.~ class, scales = "free") +
#   geom_point(alpha = 0.8, aes(color = col))+
#   geom_line(data = curve, aes(x = x, y = y), linetype = 6, size = 1.25) +
#   labs(x = "log10 siRNA counts per million per kb\nin sperm",
#        y = "mRNA counts per million per kb\nin egg") +
#   theme_minimal() +
#   theme(legend.position = "none") +
#   scale_color_manual(values = c("tomato1", "grey40", "dodgerblue2")) +
#   theme(text = element_text(size = 14, face="bold")) +
#   theme(axis.text.x = element_text(colour="black", angle = 45, hjust = 1)) +
#   theme(axis.text.y = element_text(colour="black"))
# 
# ggsave(filename = "sperm siRNA vs. egg mRNA.png", height = 5, width = 5)
```















##sperm siRNA vs. zygote 5hr mRNA
```{r}
z5_mRNA <- mRNA %>% 
 filter(sample_type == "zygote 5hr") %>% 
               select(-RNA_type, -genotype)

z5_mRNA %>% head(10)
```
```{r}
sp_z5 <- siRNA %>% 
  filter(sample_type == "sperm") %>% 
  select(-RNA_type, -genotype, -sample_type) %>% 
  full_join(z5_mRNA, by = c("tag", "class"))

sp_z5 %>% tail(10)
```
```{r}
# curve <- data.frame(x = seq(0.29, 3, by= 0.001))
# curve <- curve %>% 
#   mutate(y = 1/x)
# 
# sp_z5 %>% 
#   mutate(col = case_when(
#     mean.nor.count.x * 10^6 > 50 ~ "sperm cell",
#     mean.nor.count.y * 10^6 > 100 ~ "zygote 2.5hr",
#     mean.nor.count.x * 10^6 < 50 &
#       mean.nor.count.y * 10^6 < 100 ~ "neither"
#   )) %>% 
#   ggplot(aes(x = log10(mean.nor.count.x * 10^6 + 1), y = log10(mean.nor.count.y * 10^6 + 1))) +
#   facet_grid(.~ class, scales = "free") +
#   geom_point(alpha = 0.8, aes(color = col))+
#   geom_line(data = curve, aes(x = x, y = y), linetype = 6, size = 1.25) +
#   labs(x = "log10 siRNA counts per million per kb\nin sperm",
#        y = "log10 mRNA counts per million per kb\nin zgyote 5hrs") +
#   theme_minimal() +
#   theme(legend.position = "none") +
#   scale_color_manual(values = c("grey40", "dodgerblue2", "dodgerblue3")) +
#   theme(text = element_text(size = 14, face="bold")) +
#   theme(axis.text.x = element_text(colour="black", angle = 45, hjust = 1)) +
#   theme(axis.text.y = element_text(colour="black"))
# 
# ggsave(filename = "sperm siRNA vs. z5 mRNA.png", height = 5, width = 5)
```
```{r}
fit_df_sp_egg_z5 <- rbind(sp_egg, sp_z5) %>% 
  mutate(y = log10(mean.nor.count.y  * 10^6 + 1.01)) %>% 
  mutate(x = 1/log10(mean.nor.count.x  * 10^6 + 1.01)) %>% 
  mutate(y_fit = x) %>% 
  mutate(delta = y - y_fit) %>% 
  mutate(side = case_when(
    delta > 0 ~ "out",
    delta < 0 ~ "in"
  )) %>% 
  group_by(sample_type, class, side) %>% 
  summarise(number = n()) %>% 
  ungroup() %>% 
  mutate(x = case_when(
    side == "in" ~ 1,
    side == "out" ~2
  )) %>% 
  mutate(y = case_when(
    side == "in" ~ 0.1,
    side == "out" ~2
  )) 

fit_df_sp_egg_z5
```
```{r}
rbind(sp_egg, sp_z5) %>% 
  mutate(col = case_when(
    mean.nor.count.x * 10^6 > 50 ~ "sperm",
    mean.nor.count.y * 10^6 > 100 ~ "not sperm",
    mean.nor.count.x * 10^6 < 50 &
      mean.nor.count.y * 10^6 < 100 ~ "neither"
  )) %>% 
  mutate(col2 = case_when(
    col == "sperm" ~ "sperm",
    col == "not sperm" &
      sample_type == "egg" ~ "egg",
    col == "not sperm" & 
      sample_type == "zygote 5hr" ~ "zygote 5hr",
    col == "neither" ~ "neither"
  )) %>% 
  ggplot(aes(x = log10(mean.nor.count.x * 10^6 + 1), y = log10(mean.nor.count.y * 10^6 + 1))) +
  facet_grid(class ~ sample_type, scales = "free") +
  geom_point(alpha = 0.8, aes(color = col2))+
  geom_line(data = curve, aes(x = x, y = y), linetype = 6, size = 1.25) +
  geom_text(data = fit_df_sp_egg_z5, aes(x = x, y = y, label = number), size = 5, fontface = "bold") +
  labs(x = "log10 siRNA counts per million per kb\nin sperm",
       y = "log10 mRNA counts per million per kb\nin egg or zygote 5hr") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_color_manual(values = c("tomato1", "grey60", "dodgerblue2", "dodgerblue3")) +
  theme(text = element_text(size = 14, face="bold")) +
  theme(axis.text.x = element_text(colour="black", angle = 45, hjust = 1)) +
  theme(axis.text.y = element_text(colour="black"))

ggsave(filename = "sperm siRNA vs.egg.z5 mRNA.png", height = 5, width = 5)
```




#rank order changes across sample type 
```{r}
RNA <- siRNA %>% 
  select(-mean.nor.count.24) %>% 
  rbind(mRNA)

RNA %>% head(10)
```
```{r}
jacknife <- sample(unique(RNA$tag), 100)
RNA[RNA$tag %in% jacknife, ] %>% 
  filter(genotype == "WT") %>% 
  filter(sample_type != "seedling protoplast") %>% 
  mutate(x_lab = case_when(
    sample_type == "egg cell" ~ "egg",
    str_detect(sample_type, "ovary") ~ "ovary",
    sample_type == "leaf" ~ "leaf",
    sample_type == "root" ~ "root",
    str_detect(sample_type, "pollen") ~ "pollen VC",
    str_detect(sample_type, "seedling") ~ "seedling",
    str_detect(sample_type, "sperm") ~ "sperm",
    str_detect(sample_type, "zygote 2.5hr") ~ "Z2.5 hrs",
    str_detect(sample_type, "zygote 5hr") ~ "Z5 hrs",
    str_detect(sample_type, "zygote 9hr") ~ "Z9 hrs"
  )) %>% 
  ggplot(aes(x = x_lab, y = log10(mean.nor.count * 10^6 +1))) +
  facet_grid(class ~ RNA_type, space = "free_x", scales = "free") +
  geom_line(aes(group = tag, color = tag)) +
  labs(x = NULL,
       y = "log10 counts per million per kb") + 
  theme_minimal() +
  theme(legend.position = "none") +
  theme(text = element_text(size = 14, face="bold")) +
  theme(axis.text.x = element_text(colour="black", angle = 45, hjust = 1)) +
  theme(axis.text.y = element_text(colour="black"))

ggsave(filename = "TE_exp_differs.png", height = 5, width = 5)
```









#multivariable statistics
##siRNA
```{r}
g24_l %>% head(10)

g24_w <- g24_l %>% 
  select( -kb, -lib, -lib.size, -`24nt`, -sample_type, -genotype, -nor.count.24, -count) %>% 
  spread(sample_ID, nor.count)

g24_w %>% head(10)
```
```{r}
t24_w <- t24_l %>% 
  select(-kb, -lib, -lib.size, -`24nt`, -sample_type, -genotype, -nor.count.24, -count) %>% 
  spread(sample_ID, nor.count)

t24_w %>% head(10)
```
```{r}
siRNA_w <- rbind(g24_w, t24_w) 
siRNA_mat <- siRNA_w[, -(1:2)]
row.names(siRNA_mat) <- paste(siRNA_w$tag, siRNA_w$class, sep = ":")

siRNA_mat %>% head(10)

```
```{r}
sample_des <- sample_des %>% 
  arrange(sample_ID)

sample_des

sample_des1 <- sample_des[sample_des$sample_ID %in% g24_l$sample_ID, ]
dim(siRNA_mat)
dim(sample_des1)
```
```{r}
adonis((t(log10(siRNA_mat * 10^6 + 1))) ~ sample_type * genotype, sample_des1, method= "e")
```
```{r}
pal8 <- c("tomato1", "darkgreen", "orangered3", "orange", "grey40", "seagreen", "seagreen", "dodgerblue2")
```

```{r}
pc <- prcomp(t(log10(siRNA_mat * 10^6 + 1)))
pc_importance <- as.data.frame(t(summary(pc)$importance))
pc_importance

ggplot(pc_importance, aes(x = 1:length( `Proportion of Variance`), y = `Proportion of Variance`) ) +
  geom_bar(stat = 'identity') +
  xlab('dimension') +
  theme_bw()

ggplot(pc_importance, aes(x = 1:length(`Cumulative Proportion`), y = `Cumulative Proportion`) ) +
  geom_point() +
  xlab('dimension') +
  ylab('cumulative variance') +
  ylim(c(0, 1.1))+
  theme_bw()

pc_nice <- cbind(sample_des1, pc$x)
pc_nice <- pc_nice %>% 
  mutate(type = case_when(
    sample_type == "seedling segment" |
      sample_type == "seedling protoplast" |
      sample_type == "root" |
      sample_type == "leaf" ~ "vegetative tissues",
    sample_type == "egg cell" |
      sample_type == "ovary" ~ "female",
    sample_type == "sperm cell" |
      sample_type == "pollen vegetative cell" ~ "male"
  )) %>% 
  mutate(type = factor(type, levels = c("female", "vegetative tissues", "male")))

ggplot(pc_nice, aes(PC1, PC2)) +
  #stat_ellipse(aes(fill = type), alpha = 0.3, level = 0.9, type = "t", geom = "polygon") +
  geom_point(aes(color = sample_type), size = 3.5, alpha = 0.8) +
  labs(x = paste("PC1 (", pc_importance[1, 2]*100, "% of Variance)", sep = ""), 
       y = paste("PC2 (", pc_importance[2, 2]*100, "% of Variance)", sep = ""),
       fill = NULL,
       color = NULL) +
  scale_color_manual(values = pal8) +
  #scale_shape_manual(values = c(15, 17, 16)) +
  #scale_fill_manual() + 
  theme_minimal()+
  theme(text = element_text(size= 14, face="bold")) +
  theme(axis.text.x=element_text(colour = "black")) +
  theme(axis.text.y=element_text(colour = "black"))
#ggsave(filename = "miR_PCA.png")
```
##mRNA
```{r}
gm_l %>% head(10)

gm_w <- gm_l %>% 
  select( -kb, -library, -Total,  -sample_type, -count) %>% 
  spread(sample_ID, nor.count)

gm_w %>% head(10)
```
```{r}
tm_l %>% head(10)

tm_w <- tm_l %>% 
  select( -kb, -library, -Total,  -sample_type, -count) %>% 
  spread(sample_ID, nor.count)

tm_w %>% head(10)
```
```{r}
mRNA_w <- rbind(gm_w, tm_w) 
mRNA_mat <-mRNA_w[, -(1:2)]
row.names(mRNA_mat) <- paste(mRNA_w$tag, mRNA_w$class, sep = ":")

mRNA_mat %>% head(10)
```
```{r}
mRNA_sample_des <- mRNA_sample_des %>% 
  arrange(sample_ID)

#mRNA_sample_des

mRNA_sample_des1 <- mRNA_sample_des[mRNA_sample_des$sample_ID %in% gm_l$sample_ID, ]
dim(mRNA_mat)
dim(mRNA_sample_des1)
```
```{r}
adonis((t(log10(mRNA_mat * 10^6 + 1))) ~ sample_type, mRNA_sample_des1, method= "e")
```
```{r}
pal.m <- c("tomato1", "orange", "seagreen", "dodgerblue2", "dodgerblue2", "dodgerblue3", "dodgerblue4")
```

```{r}
pcm <- prcomp(t(log10(mRNA_mat * 10^6 + 1)))
pcm_importance <- as.data.frame(t(summary(pcm)$importance))
pcm_importance

ggplot(pcm_importance, aes(x = 1:length( `Proportion of Variance`), y = `Proportion of Variance`) ) +
  geom_bar(stat = 'identity') +
  xlab('dimension') +
  theme_bw()

ggplot(pcm_importance, aes(x = 1:length(`Cumulative Proportion`), y = `Cumulative Proportion`) ) +
  geom_point() +
  xlab('dimension') +
  ylab('cumulative variance') +
  ylim(c(0, 1.1))+
  theme_bw()

pcm_nice <- cbind(mRNA_sample_des1, pcm$x)
pcm_nice <- pcm_nice %>% 
  mutate(category = case_when(
    str_detect(sample_type, pattern = "egg") ~ "egg",
    str_detect(sample_type, pattern = "sperm|pollen VC") ~ "male germline",
    str_detect(sample_type, pattern = "zygote") ~ "zygote",
    str_detect(sample_type, pattern = "seedling") ~ "seedling"
  )) %>% 
  mutate(category = factor(category, levels = c("egg", "seedling","zygote", "male germline")))

ggplot(pcm_nice, aes(PC1, PC2)) +
  #stat_ellipse(aes(fill = category), alpha = 0.3, level = 0.9, type = "t", geom = "polygon") +
  geom_point(aes(color = sample_type, shape = category), size = 3.5, alpha = 0.8) +
  labs(x = paste("PC1 (", pcm_importance[1, 2]*100, "% of Variance)", sep = ""), 
       y = paste("PC2 (", pcm_importance[2, 2]*100, "% of Variance)", sep = ""),
       fill = NULL,
       color = NULL,
       shape = NULL) +
  scale_color_manual(values = pal.m) +
  scale_shape_manual(values = 15:18) +
  #scale_fill_manual() + 
  theme_minimal()+
  theme(text = element_text(size= 14, face="bold")) +
  theme(axis.text.x=element_text(colour = "black")) +
  theme(axis.text.y=element_text(colour = "black"))


#ggsave(filename = "miR_PCA.png")
```

```{r}
(g24$X.4 - g24$X.3) %>% sum() / 10^6
(t24$X.4 - t24$X.3) %>% sum() / 10^6
```

#pollen mRNA vs. sperm siRNA
```{r}
pv_mRNA <- mRNA %>% 
 filter(sample_type == "pollen VC") %>% 
               select(-RNA_type, -genotype)

pv_mRNA %>% head(10)
```
```{r}
sp_pv <- siRNA %>% 
  filter(sample_type == "sperm") %>% 
  select(-RNA_type, -genotype, -sample_type) %>% 
  full_join(pv_mRNA, by = c("tag", "class"))

sp_pv %>% tail(10)
```
```{r}
fit_df_sp_pv <- sp_pv %>% 
  mutate(y = log10(mean.nor.count.y  * 10^6 + 1.01)) %>% 
  mutate(x = 1/log10(mean.nor.count.x  * 10^6 + 1.01)) %>% 
  mutate(y_fit = x) %>% 
  mutate(delta = y - y_fit) %>% 
  mutate(side = case_when(
    delta > 0 ~ "out",
    delta < 0 ~ "in"
  )) %>% 
  group_by(sample_type, class, side) %>% 
  summarise(number = n()) %>% 
  ungroup() %>% 
  mutate(x = case_when(
    side == "in" ~ 1,
    side == "out" ~2
  )) %>% 
  mutate(y = case_when(
    side == "in" ~ 0.1,
    side == "out" ~2
  )) 

fit_df_sp_pv
```

```{r}
sp_pv %>% 
  mutate(col = case_when(
    mean.nor.count.x * 10^6 > 50 ~ "sperm",
    mean.nor.count.y * 10^6 > 100 ~ "pollen VC",
    mean.nor.count.x * 10^6 < 50 &
      mean.nor.count.y * 10^6 < 100 ~ "neither"
  )) %>%
  ggplot(aes(x = log10(mean.nor.count.x * 10^6 + 1), y = log10(mean.nor.count.y * 10^6 + 1))) +
  facet_grid(.~ class, scales = "free") +
  geom_point(alpha = 0.8, aes(color = col))+
  geom_line(data = curve, aes(x = x, y = y), linetype = 6, size = 1.25) +
  geom_text(data = fit_df_sp_pv, aes(x = x, y = y, label = number), size = 5, fontface = "bold") +
  labs(x = "log10 siRNA counts per million per kb\nin sperm",
       y = "log10 mRNA counts per million per kb\nin pollen VC") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_color_manual(values = c("grey40", "orange", "dodgerblue2")) +
  theme(text = element_text(size = 14, face="bold")) +
  theme(axis.text.x = element_text(colour="black", angle = 45, hjust = 1)) +
  theme(axis.text.y = element_text(colour="black"))

ggsave(filename = "sperm siRNA vs. pollen mRNA.png", height = 5, width = 5)
```





#correlation heatmaps
##mRNA
```{r}
mRNA_cor <- mRNA_mat %>% cor(method = "s")

mRNA_cor_df <- mRNA_cor %>% 
  as.data.frame() %>% 
  mutate(sample_ID = row.names(mRNA_cor)) %>% 
  gather("sample_ID.y", "cor", 1:21) %>% 
  inner_join(mRNA_sample_des1, by = "sample_ID") %>% 
  inner_join(mRNA_sample_des1 %>% 
               mutate(sample_ID.y = sample_ID), by = "sample_ID.y") %>%
  group_by(sample_type.x, sample_type.y) %>%
  summarise(mean.cor = mean(cor)) 

mRNA_cor_df %>% head(10)
#dim(mRNA_cor)
```

```{r}
mRNA_order_cor <- mRNA_cor_df %>%
  ungroup() %>% 
  filter(sample_type.y == "egg") %>% 
  arrange(mean.cor) %>% 
  mutate(Order = order(mean.cor)) %>% 
  select(sample_type.x, Order) 

mRNA_order_cor
```
```{r}
mRNA_order_cor %>% 
  inner_join(mRNA_cor_df, by = "sample_type.x") %>% 
  inner_join(mRNA_order_cor, by = c("sample_type.y" = "sample_type.x")) %>% 
  mutate(d = (Order.x + 0.05)^2 + (Order.y + 0.05)^2) %>% 
  distinct(d, .keep_all = T) %>% 
  ggplot(aes(x = reorder(sample_type.x, Order.x), y = reorder(sample_type.y, Order.y))) +
  geom_tile(aes(fill = mean.cor)) +
  geom_text(aes(label = mean.cor %>% round(2)), size = 5, fontface = "bold") +
  scale_fill_gradientn(colours = brewer.pal(9, "YlOrRd"), na.value = NA) +
  labs(x = NULL, 
       y = NULL,
       fill = "cor") +
  theme_minimal() +
  theme(text = element_text(size= 14, face="bold")) +
  theme(axis.text.x=element_text(colour = "black", angle = 45, hjust = 1)) +
  theme(axis.text.y=element_text(colour = "black")) 

ggsave(filename = "cor_heatmap_mRNA.png")
```
##siRNA
```{r}
siRNA_cor <- siRNA_mat %>% cor(method = "s")

siRNA_cor_df <- siRNA_cor %>% 
  as.data.frame() %>% 
  mutate(sample_ID = row.names(siRNA_cor)) %>% 
  gather("sample_ID.y", "cor", 1:28) %>% 
  inner_join(sample_des1, by = "sample_ID") %>% 
  inner_join(sample_des1 %>% 
               mutate(sample_ID.y = sample_ID), by = "sample_ID.y") %>%
  group_by(sample_type.x, sample_type.y) %>%
  summarise(mean.cor = mean(cor)) %>% 
  ungroup()

siRNA_cor_df 
#siRNA_cor
```
```{r}
siRNA_order_cor <- siRNA_cor_df %>%
  filter(sample_type.y == "egg") %>% 
  arrange(mean.cor) %>% 
  mutate(Order = order(mean.cor)) %>% 
  select(sample_type.x, Order) 

siRNA_order_cor
```
```{r}
siRNA_order_cor %>% 
  inner_join(siRNA_cor_df, by = "sample_type.x") %>% 
  inner_join(siRNA_order_cor, by = c("sample_type.y" = "sample_type.x")) %>% 
  mutate(d = (Order.x + 0.05)^2 + (Order.y + 0.05)^2) %>% 
  distinct(d, .keep_all = T) %>% 
  ggplot(aes(x = reorder(sample_type.x, Order.x), y = reorder(sample_type.y, Order.y))) +
  geom_tile(aes(fill = mean.cor)) +
  geom_text(aes(label = mean.cor %>% round(2)), size = 5, fontface = "bold") +
  scale_fill_gradientn(colours = brewer.pal(9, "YlOrRd"), na.value = NA) +
  labs(x = NULL, 
       y = NULL,
       fill = "cor") +
  theme_minimal() +
  theme(text = element_text(size= 14, face="bold")) +
  theme(axis.text.x=element_text(colour = "black", angle = 45, hjust = 1)) +
  theme(axis.text.y=element_text(colour = "black")) 

ggsave(filename = "cor_heatmap_siRNA.png")
```
#scatter sperm vs. pollen
##siRNA
```{r}
sp_pv_siRNA <- siRNA %>% 
  filter(sample_type == "pollen VC" |
           sample_type == "sperm") %>% 
  select(sample_type, tag, class, mean.nor.count) %>% 
  spread(sample_type, mean.nor.count)

sp_pv_siRNA %>% head(20)
```
```{r}
sp_pv_siRNA %>% 
  ggplot(aes(x = log10(`pollen VC`*10^6 + 1) , y = log10(sperm * 10^6 + 1))) +
  geom_point() +
  facet_grid(. ~ class)
```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
